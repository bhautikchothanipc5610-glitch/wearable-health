<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wearable Health Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #2563eb;
      --accent-dark: #1e3a8a;
      --muted: #6b7280;
      --success: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
    }

    body {
      font-family: 'Poppins', 'Segoe UI', Arial, sans-serif;
      background: #eef2f7;
      margin: 0;
      color: #0f172a;
    }

    header {
      text-align: center;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: #fff;
      padding: 18px 24px;
      box-shadow: 0 6px 18px rgba(16,24,40,0.1);
    }
    header h1 { margin: 0; font-size: 28px; font-weight: 600; }

    .dashboard {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      width: 90%;
      margin: 30px auto;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }

    /* Chart */
    #healthChart {
      max-height: 320px;
    }

    /* Gauge Section */
    #gaugeSection {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 30px;
    }
    .gauge-container {
      position: relative;
      width: 140px;
      height: 140px;
    }
    .gauge-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 600;
      color: #111827;
    }
    .gauge-title {
      margin-top: 6px;
      font-weight: 600;
      color: #374151;
    }

    .download-btn {
      background: linear-gradient(90deg,var(--accent),var(--accent-dark));
      color: #fff;
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      margin-top: 20px;
      font-weight: 600;
      box-shadow: 0 6px 14px rgba(37,99,235,0.2);
      transition: transform 0.2s;
    }
    .download-btn:hover {
      transform: scale(1.05);
    }

    /* Table */
    .table-card {
      width: 92%;
      margin: 30px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: var(--accent);
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f9fafb;
    }

    @media (max-width: 900px) {
      .dashboard {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1>Wearable Health Monitoring Dashboard</h1>
  </header>

  <div class="dashboard">
    <div class="card">
      <h3>Heart Rate & HRV</h3>
      <canvas id="healthChart"></canvas>
    </div>

    <div class="card" id="gaugeSection">
      <div class="gauge-container">
        <canvas id="stressGauge"></canvas>
        <div class="gauge-label" id="stressValue">--%</div>
      </div>
      <div class="gauge-title">üß† Stress Level</div>

      <div class="gauge-container">
        <canvas id="tempGauge"></canvas>
        <div class="gauge-label" id="tempValue">-- ¬∞C</div>
      </div>
      <div class="gauge-title">üå°Ô∏è Body Temperature</div>

      <button class="download-btn" onclick="window.location='/export'">
        ‚¨áÔ∏è Download Health Data (CSV)
      </button>
    </div>
  </div>

  <div class="table-card">
    <h3>Recent Health Data</h3>
    <table id="data">
      <tr>
        <th>Time</th>
        <th>Heart Rate</th>
        <th>Temperature</th>
        <th>HRV</th>
        <th>Alert</th>
      </tr>
    </table>
  </div>

  <script>
    // Heart Rate & HRV Chart ‚Äî fixed smoother visuals
    const ctx = document.getElementById('healthChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Heart Rate (BPM)',
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239,68,68,0.15)',
            borderWidth: 2,
            data: [],
            tension: 0.4,
            fill: true,
            pointRadius: 3
          },
          {
            label: 'HRV',
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59,130,246,0.15)',
            borderWidth: 2,
            data: [],
            tension: 0.4,
            fill: true,
            pointRadius: 3
          }
        ]
      },
      options: {
        animation: { duration: 500, easing: 'easeOutCubic' },
        plugins: { legend: { position: 'top', labels: { boxWidth: 12 } } },
        scales: {
          x: {
            ticks: { callback: (val, i) => chart.data.labels[i]?.split(' ')[1] || '' }
          },
          y: { beginAtZero: false }
        }
      }
    });

    // === Gauges ===
    function createGauge(canvasId, color) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      return new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [0, 100],
            backgroundColor: [color, '#e5e7eb'],
            borderWidth: 0,
            borderRadius: [50, 0]  // only color arc rounded
          }]
        },
        options: {
          rotation: -90,
          circumference: 360,
          cutout: '80%',
          animation: { duration: 800, easing: 'easeOutCubic' },
          plugins: { legend: { display: false } }
        }
      });
    }

    const stressGauge = createGauge('stressGauge', '#ef4444');
    const tempGauge = createGauge('tempGauge', '#f59e0b');

    function updateGauge(chart, value, max = 100) {
      const percent = Math.min((value / max) * 100, 100);
      chart.data.datasets[0].data = [percent, 100 - percent];
      chart.update();
    }

    async function loadData() {
      const res = await fetch('/api/data');
      const data = await res.json();

      const table = document.getElementById("data");
      table.innerHTML = `
        <tr>
          <th>Time</th>
          <th>Heart Rate</th>
          <th>Temperature</th>
          <th>HRV</th>
          <th>Alert</th>
        </tr>
      `;

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.timestamp.split(' ')[1]}</td>
          <td>${row.heart_rate}</td>
          <td>${row.temperature}</td>
          <td>${row.hrv}</td>
          <td>${row.alert}</td>
        `;
        table.appendChild(tr);
      });

      const timestamps = data.map(r => r.timestamp).reverse();
      const heartRates = data.map(r => r.heart_rate).reverse();
      const hrvs = data.map(r => r.hrv).reverse();

      chart.data.labels = timestamps;
      chart.data.datasets[0].data = heartRates;
      chart.data.datasets[1].data = hrvs;
      chart.update();

      if (data.length > 0) {
        const last = data[data.length - 1];
        updateGauge(stressGauge, last.stress_score || 0, 50);
        document.getElementById('stressValue').innerText = `${Math.min(((last.stress_score || 0) / 50 * 100), 100).toFixed(0)}%`;
        updateGauge(tempGauge, last.temperature || 36, 40);
        document.getElementById('tempValue').innerText = `${last.temperature?.toFixed(1)} ¬∞C`;
      }
    }

    setInterval(loadData, 2000);
    window.onload = loadData;
  </script>
</body>
</html>
