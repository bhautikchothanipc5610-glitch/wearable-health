// ==========================
// Frontend Dashboard Logic
// ==========================

// Chart.js setup
const ctx = document.getElementById('healthChart').getContext('2d');
const healthChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      {
        label: 'Heart Rate (BPM)',
        borderColor: '#e74c3c',
        fill: false,
        data: [],
      },
      {
        label: 'HRV (ms)',
        borderColor: '#3498db',
        fill: false,
        data: [],
      },
    ],
  },
  options: {
    responsive: true,
    scales: {
      x: { title: { display: true, text: 'Time' } },
      y: { beginAtZero: true },
    },
  },
});

// Temperature gauge setup
const tempCtx = document.getElementById('tempGauge').getContext('2d');
let tempGauge = new Chart(tempCtx, {
  type: 'doughnut',
  data: {
    labels: ['Temp', ''],
    datasets: [{
      data: [0, 100],
      backgroundColor: ['#f39c12', '#ecf0f1'],
      borderWidth: 0
    }]
  },
  options: {
    rotation: -90,
    circumference: 180,
    cutout: '80%',
    plugins: { legend: { display: false } }
  }
});

function updateTempGauge(temp) {
  document.getElementById('tempValue').innerText = `${temp.toFixed(1)} ¬∞C`;
  tempGauge.data.datasets[0].data = [temp, 50 - temp / 2];
  tempGauge.update();
}

// ==========================
// Fetch Data Function
// ==========================
async function fetchData() {
  try {
    const res = await fetch('/api/latest'); // <-- check this route matches your Flask route
    const data = await res.json();
    console.log('üì• Latest data:', data);

    const time = new Date().toLocaleTimeString();
    const heartRate = data.heart_rate;
    const hrv = data.hrv;
    const temp = data.temperature;

    // Update Chart
    healthChart.data.labels.push(time);
    healthChart.data.datasets[0].data.push(heartRate);
    healthChart.data.datasets[1].data.push(hrv);
    if (healthChart.data.labels.length > 20) {
      healthChart.data.labels.shift();
      healthChart.data.datasets[0].data.shift();
      healthChart.data.datasets[1].data.shift();
    }
    healthChart.update();

    // Update Temperature Gauge
    updateTempGauge(temp);

    // Update Table
    const row = `<tr>
      <td>${time}</td>
      <td>${heartRate}</td>
      <td>${temp.toFixed(1)}</td>
      <td>${hrv}</td>
      <td>${heartRate === 0 ? '‚ö†Ô∏è No Finger' : '‚úÖ Normal'}</td>
    </tr>`;
    document.getElementById('data').insertAdjacentHTML('beforeend', row);
  } catch (err) {
    console.error('‚ùå Error fetching data:', err);
  }
}

// Fetch every 2 seconds
setInterval(fetchData, 2000);
fetchData();
